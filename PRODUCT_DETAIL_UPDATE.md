# 产品详情页功能更新说明

## 更新概述

新增产品详情页面功能，用户可以点击库存列表中的任意产品，查看该产品的详细出入库数据和趋势分析。

## 新增功能

### 1. 产品详情页面

**文件：** `frontend/product_detail.html` 和 `frontend/product_detail.js`

**功能包括：**

#### 统计卡片
- **当前库存**：显示产品的实时库存数量
- **今日入库**：显示当天该产品的入库数量及与昨日对比
- **今日出库**：显示当天该产品的出库数量及与昨日对比
- **安全库存**：显示安全库存阈值及当前库存状态（正常/偏低/告急）

#### 可视化图表
- **近7天出入库趋势**：折线图展示最近7天该产品的入库和出库趋势
- **出入库占比**：饼图展示该产品的总入库和总出库占比

#### 出入库记录
- 显示最近30条该产品的出入库记录
- 包含时间、类型（入库/出库）、数量、操作人、原因等信息
- 记录按时间倒序排列

### 2. 点击交互

**修改文件：** `frontend/app.js` 和 `frontend/style.css`

**功能：**
- 库存列表中的每一行都可以点击
- 鼠标悬停时显示高亮效果（蓝色背景 + 轻微位移）
- 点击后跳转到对应产品的详情页面

### 3. 后端API接口

**修改文件：** `backend/app.py`

新增3个API接口：

#### (1) GET /api/materials/product-stats

获取单个产品的统计数据

**参数：**
- `name`: 产品名称（必填）

**返回示例：**
```json
{
  "name": "watcher-xiaozhi(标准版)",
  "sku": "FG-WZ-STD",
  "current_stock": 57,
  "unit": "台",
  "safe_stock": 15,
  "location": "H区-02",
  "today_in": 10,
  "today_out": 5,
  "in_change": 100.0,
  "out_change": 25.0,
  "total_in": 120,
  "total_out": 63
}
```

#### (2) GET /api/materials/product-trend

获取单个产品的近7天趋势

**参数：**
- `name`: 产品名称（必填）

**返回示例：**
```json
{
  "dates": ["11-01", "11-02", "11-03", "11-04", "11-05", "11-06", "11-07"],
  "in_data": [10, 15, 8, 12, 20, 5, 10],
  "out_data": [5, 8, 6, 10, 15, 3, 5]
}
```

#### (3) GET /api/materials/product-records

获取单个产品的出入库记录

**参数：**
- `name`: 产品名称（必填）

**返回示例：**
```json
[
  {
    "type": "in",
    "quantity": 10,
    "operator": "采购部",
    "reason": "新采购到货",
    "created_at": "2025-11-07 14:30:00"
  },
  {
    "type": "out",
    "quantity": 5,
    "operator": "销售部",
    "reason": "销售出库",
    "created_at": "2025-11-07 10:15:00"
  }
]
```

## 使用流程

### 1. 从首页访问

1. 打开仓库管理系统首页（http://localhost:2125）
2. 滚动到"库存列表"部分
3. 点击任意产品行

### 2. 查看详情

产品详情页面将显示：
- 页面标题显示产品名称
- 4个统计卡片展示关键数据
- 2个图表展示趋势和占比
- 出入库记录表格

### 3. 返回首页

点击左上角的"返回"按钮

## 页面截图说明

### 首页 - 库存列表
- 每一行都有悬停高亮效果
- 鼠标指针变为手型，提示可点击
- 点击后跳转到详情页

### 详情页 - 统计卡片
```
┌─────────────┬─────────────┬─────────────┬─────────────┐
│ 当前库存    │ 今日入库    │ 今日出库    │ 安全库存    │
│   57 台     │   10        │    5        │   15        │
│             │  +100%      │   +25%      │  正常       │
└─────────────┴─────────────┴─────────────┴─────────────┘
```

### 详情页 - 图表
```
┌────────────────────────────┬────────────────────────┐
│ 近7天出入库趋势            │ 出入库占比             │
│ (折线图)                   │ (饼图)                 │
│                            │                        │
│ 入库 ────                  │  入库 66.7%           │
│ 出库 ────                  │  出库 33.3%           │
└────────────────────────────┴────────────────────────┘
```

### 详情页 - 出入库记录
```
┌──────────────────┬──────┬────┬──────┬────────┐
│ 时间             │ 类型 │数量│操作人│ 原因   │
├──────────────────┼──────┼────┼──────┼────────┤
│ 2025-11-07 14:30 │ 入库 │ 10 │采购部│新采购  │
│ 2025-11-07 10:15 │ 出库 │  5 │销售部│销售    │
└──────────────────┴──────┴────┴──────┴────────┘
```

## 技术实现

### 前端

**路由参数传递：**
```javascript
// 首页跳转
window.location.href = `product_detail.html?product=${encodeURIComponent(item.name)}`;

// 详情页获取
const urlParams = new URLSearchParams(window.location.search);
productName = urlParams.get('product');
```

**数据加载：**
```javascript
// 并行加载三个接口的数据
await Promise.all([
    loadProductStats(),      // 统计数据
    loadProductTrend(),      // 趋势数据
    loadProductRecords()     // 记录数据
]);
```

### 后端

**查询优化：**
- 使用 `COALESCE` 处理空值
- 使用 `DATE()` 函数按日期过滤
- 限制记录条数为最近30条

**百分比计算：**
```python
in_change = ((today_in - yesterday_in) / yesterday_in * 100) if yesterday_in > 0 else 0
```

## CSS样式

### 可点击行
```css
tbody tr.clickable {
    cursor: pointer;
    transition: all 0.2s;
}

tbody tr.clickable:hover {
    background: #e6f7ff !important;
    transform: translateX(2px);
}
```

### 类型标签
```css
.type-in {
    color: #52c41a;
    background: #f6ffed;
}

.type-out {
    color: #ff4d4f;
    background: #fff2f0;
}
```

### 返回按钮
```css
.back-btn {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px 16px;
    /* ... */
}
```

## 文件清单

### 新增文件
- ✅ `frontend/product_detail.html` - 产品详情页面HTML
- ✅ `frontend/product_detail.js` - 产品详情页面JavaScript
- ✅ `PRODUCT_DETAIL_UPDATE.md` - 本文档

### 修改文件
- ✅ `frontend/app.js` - 添加点击事件
- ✅ `frontend/style.css` - 添加新样式
- ✅ `backend/app.py` - 添加3个API接口

## 特性亮点

### 1. 用户体验
- **一键访问**：点击即可查看详情，无需额外操作
- **视觉反馈**：鼠标悬停有明显的视觉提示
- **快速导航**：返回按钮方便回到首页

### 2. 数据展示
- **多维度统计**：从多个角度展示产品数据
- **趋势分析**：通过图表直观了解变化趋势
- **历史记录**：完整的出入库操作记录

### 3. 性能优化
- **并行加载**：3个API接口并行请求，提升加载速度
- **数据限制**：记录限制为30条，避免数据过多

### 4. 响应式设计
- 继承首页的响应式布局
- 支持移动端访问
- 图表自动适配屏幕大小

## 使用示例

### 场景 1：查看热销产品趋势

1. 在库存列表中找到 "watcher-xiaozhi(标准版)"
2. 点击该行
3. 查看近7天出入库趋势图
4. 分析销售情况

### 场景 2：检查库存预警

1. 点击状态为"告急"或"偏低"的产品
2. 查看安全库存与当前库存的对比
3. 查看出入库记录了解库存变化原因
4. 决定是否需要补货

### 场景 3：追踪操作记录

1. 点击任意产品
2. 滚动到"出入库记录"部分
3. 查看具体的操作人和操作原因
4. 追溯库存变化历史

## 注意事项

1. **URL参数**：产品名称通过URL参数传递，确保正确编码
2. **数据验证**：后端会验证产品是否存在，不存在会返回404
3. **记录限制**：出入库记录只显示最近30条
4. **日期范围**：趋势图固定为最近7天

## 未来扩展

可以考虑添加以下功能：

1. **更多统计维度**
   - 月度统计
   - 年度统计
   - 自定义时间范围

2. **高级筛选**
   - 按操作人筛选记录
   - 按操作类型筛选
   - 按时间范围筛选

3. **导出功能**
   - 导出图表为图片
   - 导出记录为Excel
   - 生成PDF报告

4. **实时更新**
   - 自动刷新数据
   - WebSocket实时推送

## 总结

✅ 新增产品详情页面
✅ 添加点击交互功能
✅ 新增3个后端API接口
✅ 优化用户体验
✅ 完整的数据展示

这次更新为用户提供了更深入的产品数据查看方式，可以更好地分析和管理每个产品的库存情况！
